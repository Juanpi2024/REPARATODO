<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel <?= nombre ?></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>body{font-family:'Plus Jakarta Sans',sans-serif}.chat-box{height:calc(100vh - 180px)}</style>
</head>
<body class="bg-slate-200 h-screen flex justify-center">
    <div class="w-full max-w-md bg-white h-full shadow-2xl flex flex-col">
        <header class="bg-emerald-900 p-4 text-white flex justify-between items-center shadow-lg">
            <h1 class="font-bold text-xs uppercase tracking-widest"><?= nombre ?></h1>
            <button onclick="listar()" class="text-[9px] bg-white/10 px-4 py-2 rounded-full font-bold uppercase border border-white/20">GESTIONAR</button>
        </header>

        <main id="box" class="chat-box overflow-y-auto p-4 flex flex-col space-y-4 bg-slate-50"></main>

        <footer class="p-4 bg-white border-t flex space-x-2">
            <input id="in" type="text" placeholder="Nueva idea o link..." class="flex-1 border rounded-full px-5 py-3 text-sm focus:ring-2 focus:ring-emerald-600 outline-none">
            <button onclick="enviar()" class="bg-emerald-800 text-white p-4 rounded-full w-12 h-12 flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                <i class="fas fa-paper-plane"></i>
            </button>
        </footer>
    </div>

    <script>
        const URL = "<?= scriptURL ?>", box = document.getElementById('box');
        let ideaOrig = "";

        window.onload = () => msg("¬°Hola! üëã Escribe una idea para generar contenido real.", 'ai');

        function msg(t, type, html=false) {
            const d = document.createElement('div');
            d.className = `p-4 rounded-2xl max-w-[85%] shadow-sm text-sm ${type==='ai'?'bg-white self-start border border-slate-200 text-slate-700':'bg-emerald-800 text-white self-end'}`;
            if(html) d.innerHTML = t; else d.innerText = t;
            box.appendChild(d); box.scrollTop = box.scrollHeight; return d;
        }

        async function api(b) { const r = await fetch(URL, { method: 'POST', body: JSON.stringify(b) }); return r.json(); }

        // --- FUNCI√ìN DE COPIADO ---
        function copiar(t, btn) {
            navigator.clipboard.writeText(t);
            const original = btn.innerHTML;
            btn.innerHTML = "<i class='fas fa-check'></i>";
            btn.classList.replace('bg-slate-500', 'bg-emerald-600');
            setTimeout(() => { 
                btn.innerHTML = original; 
                btn.classList.replace('bg-emerald-600', 'bg-slate-500');
            }, 1500);
        }

        async function enviar() {
            const txt = document.getElementById('in').value; if(!txt) return;
            ideaOrig = txt; document.getElementById('in').value = "";
            msg(txt, 'user'); const load = msg("Gemini analizando... ‚è≥", 'ai');
            try {
                const res = await api({ accion: "generar", idea: txt });
                load.remove();
                if(res.status === "error") throw new Error(res.message);
                const opts = JSON.parse(res.opciones).opciones;
                let h = `<div class='space-y-3'>`;
                opts.forEach(o => {
                    const cln = o.replace(/'/g,"\\'");
                    h += `<div class="bg-white border rounded-xl p-3 shadow-sm">
                            <p class="text-[11px] mb-2 font-semibold">${o}</p>
                            <div class="flex gap-2">
                                <button onclick="pub('${cln}')" class="bg-emerald-800 text-white px-3 py-1 rounded-lg text-[9px] font-bold uppercase">Publicar</button>
                                <button onclick="copiar('${cln}', this)" class="bg-slate-500 text-white px-3 py-1 rounded-lg text-[9px] font-bold"><i class="fas fa-copy"></i></button>
                            </div>
                          </div>`;
                });
                msg(h + `</div>`, 'ai', true);
            } catch(e) { load.innerHTML = "‚ö†Ô∏è Error de Cuota. Espera 60 seg."; }
        }

        async function pub(t) {
            const status = msg("Publicando...", 'ai');
            const res = await api({ accion: "publicar", textoElegido: t, ideaOriginal: ideaOrig });
            if(res.status === "success") status.innerHTML = `‚ú® **¬°Publicado!**` + shareButtons(t);
        }

        async function listar() {
            const load = msg("Buscando publicaciones... üìã", 'ai');
            const res = await api({ accion: "leer" });
            load.remove();
            let h = `<div class="space-y-3 w-full"><p class="text-[10px] font-bold text-slate-400 uppercase">GESTI√ìN:</p>`;
            const activas = res.datos.filter(f => f.estado === "Publicar");
            activas.forEach(f => {
                const cln = f.texto.replace(/'/g,"\\'");
                h += `<div class="p-4 bg-white border rounded-2xl shadow-sm text-[11px]">
                        <p class="mb-3 leading-snug">${f.texto}</p>
                        <div class="flex gap-2">
                            <button onclick="copiar('${cln}', this)" class="bg-slate-500 text-white px-3 py-1 rounded text-[9px]"><i class="fas fa-copy"></i></button>
                            <button onclick="difWA('${cln}')" class="bg-green-500 text-white px-3 py-1 rounded text-[9px]">WSAP</button>
                            <button onclick="borrar(${f.index})" class="text-red-500 font-bold ml-auto text-[9px]">ELIMINAR</button>
                        </div>
                      </div>`;
            });
            msg(h + `</div>`, 'ai', true);
        }

        async function borrar(idx) {
            if(!confirm("¬øEliminar?")) return;
            const res = await api({ accion: "eliminar", index: idx });
            if(res.status === "success") msg("üóëÔ∏è Eliminado.", 'ai');
        }

        function shareButtons(t) {
            return `<div class="mt-3 flex gap-2 border-t pt-3">
                <button onclick="difWA('${t.replace(/'/g,"\\'")}')" class="bg-[#25D366] text-white px-4 py-2 rounded-lg text-[10px] font-bold">WHATSAPP</button>
                <button onclick="difFB()" class="bg-[#1877F2] text-white px-4 py-2 rounded-lg text-[10px] font-bold">FACEBOOK</button>
            </div>`;
        }

        function difWA(t) { window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(t + "\\n\\nVer m√°s en: " + URL.split('?')[0])}`, '_blank'); }
        function difFB() { window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(URL.split('?')[0])}`, '_blank'); }
    </script>
</body>
</html>